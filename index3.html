<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wisdom AI - Assistant IA Professionnel</title>
    <!-- Tailwind CSS + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        .message-content {
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .message-content h1, .message-content h2, .message-content h3 {
            margin: 1rem 0 0.5rem 0;
        }
        .message-content ul, .message-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .message-content li {
            margin: 0.25rem 0;
        }
        .message-content code {
            background: #f0f0f0;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
        }
        .message-content pre {
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        .copy-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .chat-bubble:hover .copy-btn {
            opacity: 1;
        }
        .theme-transition * {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-base-100 min-h-screen theme-transition">
    <div id="app" class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-base-200 flex flex-col border-r">
            <!-- Header utilisateur -->
            <div class="p-4 border-b">
                <div class="flex items-center space-x-3">
                    <div class="avatar placeholder">
                        <div class="bg-neutral text-neutral-content rounded-full w-12">
                            <span id="user-avatar">üë§</span>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm" id="user-name">Bienvenue</h3>
                        <p class="text-xs text-gray-500" id="user-email">Connectez-vous</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex-1 overflow-y-auto">
                <ul class="menu p-2">
                    <li class="menu-title">
                        <span>Navigation</span>
                    </li>
                    <li>
                        <a onclick="showChatView()" id="nav-chat">
                            <i class="fas fa-comments"></i>
                            Discussions
                        </a>
                    </li>
                    <li>
                        <a onclick="showHistoryView()" id="nav-history">
                            <i class="fas fa-history"></i>
                            Historique
                        </a>
                    </li>
                    <li>
                        <a onclick="showFilesView()" id="nav-files">
                            <i class="fas fa-file-upload"></i>
                            Fichiers
                        </a>
                    </li>
                    <li class="menu-title mt-4">
                        <span>Param√®tres</span>
                    </li>
                    <li>
                        <a onclick="showSettingsView()" id="nav-settings">
                            <i class="fas fa-cog"></i>
                            Param√®tres
                        </a>
                    </li>
                    <li>
                        <a onclick="showProfileView()" id="nav-profile">
                            <i class="fas fa-user"></i>
                            Profil
                        </a>
                    </li>
                    <li id="admin-panel-link" class="hidden">
                        <a onclick="showAdminView()" id="nav-admin">
                            <i class="fas fa-shield-alt"></i>
                            Panel Admin
                        </a>
                    </li>
                </ul>
            </div>

            <!-- D√©connexion -->
            <div class="p-4 border-t">
                <button onclick="logout()" class="btn btn-ghost btn-sm w-full justify-start">
                    <i class="fas fa-sign-out-alt"></i>
                    D√©connexion
                </button>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="navbar bg-base-200">
                <div class="flex-1">
                    <h1 class="text-xl font-bold flex items-center">
                        <i class="fas fa-robot mr-2"></i>
                        Wisdom AI
                    </h1>
                </div>
                <div class="flex-none">
                    <div class="dropdown dropdown-end">
                        <button class="btn btn-ghost btn-circle">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                            <li><a onclick="newConversation()"><i class="fas fa-plus"></i> Nouvelle discussion</a></li>
                            <li><a onclick="toggleEphemeralMode()"><i class="fas fa-hourglass-half"></i> Mode √©ph√©m√®re</a></li>
                            <li><a onclick="exportConversation()"><i class="fas fa-download"></i> Exporter</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Vue principale -->
            <div id="main-content" class="flex-1 overflow-hidden">
                <!-- Login Screen -->
                <div id="login-screen" class="h-full flex items-center justify-center bg-base-100">
                    <div class="card w-full max-w-md bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title text-center">
                                <i class="fas fa-robot text-4xl mb-2 text-primary"></i>
                                <br>Wisdom AI
                            </h2>
                            <p class="text-center text-gray-500 mb-6">
                                Assistant IA professionnel
                            </p>
                            
                            <div class="tabs tabs-boxed mb-4">
                                <a class="tab tab-active" onclick="switchToLogin()">Connexion</a>
                                <a class="tab" onclick="switchToRegister()">Inscription</a>
                            </div>

                            <!-- Formulaire de connexion -->
                            <div id="login-form">
                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text">üìß Email</span>
                                    </label>
                                    <input 
                                        type="email" 
                                        id="login-email"
                                        placeholder="votre@email.com" 
                                        class="input input-bordered"
                                    />
                                </div>
                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text">üîí Mot de passe</span>
                                    </label>
                                    <input 
                                        type="password" 
                                        id="login-password"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                        class="input input-bordered"
                                    />
                                </div>
                                <div class="form-control mt-6">
                                    <button class="btn btn-primary" onclick="loginUser()">
                                        <i class="fas fa-sign-in-alt mr-2"></i>
                                        Se connecter
                                    </button>
                                </div>
                            </div>

                            <!-- Formulaire d'inscription -->
                            <div id="register-form" class="hidden">
                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text">üë§ Nom complet</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        id="register-name"
                                        placeholder="Votre nom" 
                                        class="input input-bordered"
                                    />
                                </div>
                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text">üìß Email</span>
                                    </label>
                                    <input 
                                        type="email" 
                                        id="register-email"
                                        placeholder="votre@email.com" 
                                        class="input input-bordered"
                                    />
                                </div>
                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text">üîí Mot de passe</span>
                                    </label>
                                    <input 
                                        type="password" 
                                        id="register-password"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                        class="input input-bordered"
                                    />
                                </div>
                                <div class="form-control mt-6">
                                    <button class="btn btn-primary" onclick="registerUser()">
                                        <i class="fas fa-user-plus mr-2"></i>
                                        S'inscrire
                                    </button>
                                </div>
                            </div>

                            <div class="text-xs text-center text-gray-500 mt-4">
                                <p>Vos donn√©es sont stock√©es localement et s√©curis√©es.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Screen -->
                <div id="chat-screen" class="hidden h-full flex flex-col">
                    <!-- Messages -->
                    <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div class="text-center py-10">
                            <div class="text-5xl mb-4">üëã</div>
                            <h3 class="text-xl font-semibold">Bienvenue sur Wisdom AI</h3>
                            <p class="text-gray-500">Posez-moi une question pour commencer !</p>
                            <div class="flex justify-center space-x-2 mt-4">
                                <button class="btn btn-sm btn-ghost" onclick="sendMessageFromSuggestion('Explique-moi ce qu\'est l\'IA')">
                                    <i class="fas fa-lightbulb"></i> Qu'est-ce que l'IA ?
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="sendMessageFromSuggestion('Aide-moi √† √©crire un email professionnel')">
                                    <i class="fas fa-envelope"></i> √âcrire un email
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Input -->
                    <div class="p-4 border-t bg-base-100">
                        <div class="flex items-center space-x-2 mb-2">
                            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('file-upload').click()" title="Joindre un fichier">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(event)">
                            <select id="voice-select" class="select select-bordered select-sm max-w-xs" onchange="changeVoice()">
                                <option disabled>S√©lectionnez une voix</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input
                                type="text"
                                id="message-input"
                                placeholder="Tapez votre message..."
                                class="input input-bordered flex-1"
                                onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                            />
                            <button
                                id="voice-btn"
                                class="btn btn-secondary"
                                onclick="toggleVoice()"
                                title="Reconnaissance vocale"
                            >
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button 
                                class="btn btn-primary"
                                onclick="sendMessage()"
                                title="Envoyer le message"
                            >
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 mt-2 text-center">
                            <span id="typing-indicator" class="hidden">L'IA est en train d'√©crire...</span>
                        </div>
                    </div>
                </div>

                <!-- Historique Screen -->
                <div id="history-screen" class="hidden h-full p-6 overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">
                            <i class="fas fa-history mr-2"></i>
                            Historique des conversations
                        </h2>
                        <button class="btn btn-sm btn-ghost" onclick="clearHistory()">
                            <i class="fas fa-trash"></i> Tout effacer
                        </button>
                    </div>
                    <div id="history-list" class="space-y-3">
                        <div class="text-center py-10 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-3"></i>
                            <p>Aucune conversation pour le moment</p>
                        </div>
                    </div>
                </div>

                <!-- Fichiers Screen -->
                <div id="files-screen" class="hidden h-full p-6 overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">
                            <i class="fas fa-file-upload mr-2"></i>
                            Partage de fichiers
                        </h2>
                        <button class="btn btn-primary btn-sm" onclick="document.getElementById('file-upload-global').click()">
                            <i class="fas fa-upload mr-1"></i>
                            T√©l√©charger
                        </button>
                        <input type="file" id="file-upload-global" class="hidden" onchange="handleGlobalFileUpload(event)">
                    </div>
                    <div id="files-list" class="space-y-3">
                        <div class="text-center py-10 text-gray-500">
                            <i class="fas fa-file-alt text-3xl mb-3"></i>
                            <p>Aucun fichier t√©l√©charg√©</p>
                        </div>
                    </div>
                </div>

                <!-- Param√®tres Screen -->
                <div id="settings-screen" class="hidden h-full p-6 overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-6">
                        <i class="fas fa-cog mr-2"></i>
                        Param√®tres
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-palette mr-2"></i>
                                    Apparence
                                </h3>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Th√®me</span>
                                    </label>
                                    <select id="theme-select" class="select select-bordered" onchange="changeTheme()">
                                        <option value="light">Clair</option>
                                        <option value="dark">Sombre</option>
                                        <option value="cupcake">Pastel</option>
                                        <option value="business">Business</option>
                                        <option value="synthwave">Synthwave</option>
                                    </select>
                                </div>
                                <div class="form-control mt-4">
                                    <label class="label cursor-pointer">
                                        <span class="label-text">Mode adaptatif (auto)</span>
                                        <input type="checkbox" id="adaptive-theme" class="toggle toggle-primary" onchange="toggleAdaptiveTheme()" />
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-robot mr-2"></i>
                                    IA & Comportement
                                </h3>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Mod√®le IA</span>
                                    </label>
                                    <select id="ai-model" class="select select-bordered">
                                        <option value="mistral-medium-latest">Mistral Medium</option>
                                        <option value="mistral-small-latest">Mistral Small</option>
                                        <option value="mistral-large-latest">Mistral Large</option>
                                    </select>
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Temp√©rature (cr√©ativit√©)</span>
                                    </label>
                                    <input 
                                        type="range" 
                                        id="ai-temperature" 
                                        min="0" 
                                        max="100" 
                                        value="70" 
                                        class="range range-primary"
                                        onchange="document.getElementById('temp-value').textContent = this.value"
                                    />
                                    <div class="flex justify-between text-xs px-1">
                                        <span>Pr√©cis</span>
                                        <span id="temp-value">70</span>
                                        <span>Cr√©atif</span>
                                    </div>
                                </div>
                                <div class="form-control mt-4">
                                    <label class="label cursor-pointer">
                                        <span class="label-text">Recherche web automatique</span>
                                        <input type="checkbox" id="web-search" class="toggle toggle-primary" checked />
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-volume-up mr-2"></i>
                                    Voix & Audio
                                </h3>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Voix de synth√®se</span>
                                    </label>
                                    <select id="tts-voice" class="select select-bordered">
                                        <option value="">Voix par d√©faut</option>
                                    </select>
                                </div>
                                <div class="form-control mt-4">
                                    <label class="label">
                                        <span class="label-text">Volume</span>
                                    </label>
                                    <input 
                                        type="range" 
                                        id="tts-volume" 
                                        min="0" 
                                        max="100" 
                                        value="80" 
                                        class="range range-primary"
                                    />
                                </div>
                                <div class="form-control mt-4">
                                    <button class="btn btn-sm btn-outline" onclick="testVoice()">
                                        <i class="fas fa-play mr-2"></i>
                                        Tester la voix
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-magic mr-2"></i>
                                    Fonctionnalit√©s
                                </h3>
                                <div class="form-control">
                                    <label class="label cursor-pointer">
                                        <span class="label-text">Copie rapide (double-clic)</span>
                                        <input type="checkbox" id="quick-copy" class="toggle toggle-primary" checked />
                                    </label>
                                </div>
                                <div class="form-control mt-2">
                                    <label class="label cursor-pointer">
                                        <span class="label-text">Suggestions automatiques</span>
                                        <input type="checkbox" id="auto-suggestions" class="toggle toggle-primary" checked />
                                    </label>
                                </div>
                                <div class="form-control mt-2">
                                    <label class="label cursor-pointer">
                                        <span class="label-text">M√©moire contextuelle</span>
                                        <input type="checkbox" id="context-memory" class="toggle toggle-primary" checked />
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-control mt-6">
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save mr-2"></i>
                            Sauvegarder tous les param√®tres
                        </button>
                    </div>
                </div>

                <!-- Profil Screen -->
                <div id="profile-screen" class="hidden h-full p-6 overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-6">
                        <i class="fas fa-user mr-2"></i>
                        Profil utilisateur
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="avatar placeholder">
                                        <div class="bg-neutral text-neutral-content rounded-full w-16">
                                            <span id="profile-avatar-lg">üë§</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold" id="profile-name">Nom Utilisateur</h3>
                                        <p class="text-gray-500" id="profile-email">email@exemple.com</p>
                                        <div class="badge badge-primary mt-1">Utilisateur</div>
                                    </div>
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Nom complet</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        id="profile-full-name"
                                        placeholder="Votre nom complet" 
                                        class="input input-bordered"
                                    />
                                </div>
                                <div class="form-control mt-4">
                                    <label class="label">
                                        <span class="label-text">Email</span>
                                    </label>
                                    <input 
                                        type="email" 
                                        id="profile-email-input"
                                        placeholder="votre@email.com" 
                                        class="input input-bordered"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-key mr-2"></i>
                                    Cl√© API
                                </h3>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Votre cl√© API Mistral</span>
                                    </label>
                                    <input 
                                        type="password" 
                                        id="profile-api-key"
                                        placeholder="sk-..." 
                                        class="input input-bordered"
                                    />
                                    <label class="label">
                                        <span class="label-text-alt">Laissez vide pour utiliser la cl√© par d√©faut</span>
                                    </label>
                                </div>
                                <div class="form-control mt-4">
                                    <label class="label">
                                        <span class="label-text">Mot de passe actuel</span>
                                    </label>
                                    <input 
                                        type="password" 
                                        id="current-password"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                        class="input input-bordered"
                                    />
                                </div>
                                <div class="form-control mt-4">
                                    <label class="label">
                                        <span class="label-text">Nouveau mot de passe</span>
                                    </label>
                                    <input 
                                        type="password" 
                                        id="new-password"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                        class="input input-bordered"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-control mt-6">
                        <button class="btn btn-primary" onclick="saveProfile()">
                            <i class="fas fa-save mr-2"></i>
                            Sauvegarder le profil
                        </button>
                    </div>
                </div>

                <!-- Admin Screen -->
                <div id="admin-screen" class="hidden h-full p-6 overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-6">
                        <i class="fas fa-shield-alt mr-2"></i>
                        Panel Administrateur
                    </h2>
                    <div class="alert alert-warning mb-6">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Acc√®s r√©serv√© aux administrateurs. Code d'authentification requis.</span>
                    </div>
                    <div class="card bg-base-100 shadow-xl mb-6">
                        <div class="card-body">
                            <h3 class="card-title">
                                <i class="fas fa-key mr-2"></i>
                                Authentification Admin
                            </h3>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Code d'administration</span>
                                </label>
                                <input 
                                    type="password" 
                                    id="admin-code"
                                    placeholder="wisdom+17@" 
                                    class="input input-bordered"
                                />
                            </div>
                            <div class="form-control mt-4">
                                <button class="btn btn-primary" onclick="authenticateAdmin()">
                                    <i class="fas fa-lock mr-2"></i>
                                    Acc√©der au panel
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="admin-content" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h3 class="card-title">
                                        <i class="fas fa-users mr-2"></i>
                                        Gestion des utilisateurs
                                    </h3>
                                    <div class="overflow-x-auto">
                                        <table class="table table-zebra">
                                            <thead>
                                                <tr>
                                                    <th>Nom</th>
                                                    <th>Email</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="users-table">
                                                <tr>
                                                    <td colspan="3" class="text-center">Chargement...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h3 class="card-title">
                                        <i class="fas fa-cogs mr-2"></i>
                                        Configuration syst√®me
                                    </h3>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Cl√© API par d√©faut</span>
                                        </label>
                                        <input 
                                            type="password" 
                                            id="default-api-key"
                                            placeholder="sk-..." 
                                            class="input input-bordered"
                                        />
                                    </div>
                                    <div class="form-control mt-4">
                                        <label class="label">
                                            <span class="label-text">Limite de requ√™tes/jour</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            id="daily-limit"
                                            value="100" 
                                            class="input input-bordered"
                                        />
                                    </div>
                                    <div class="form-control mt-4">
                                        <button class="btn btn-primary" onclick="saveAdminSettings()">
                                            <i class="fas fa-save mr-2"></i>
                                            Sauvegarder
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isListening = false;
        let recognition = null;
        let currentUser = null;
        let conversations = [];
        let files = [];
        let currentConversation = null;
        let isEphemeralMode = false;
        let tts = null;
        let voices = [];

        // Configuration syst√®me
        const ADMIN_CODE = "wisdom+17@";
        const DEFAULT_API_KEY = "votre_cle_api_par_defaut_ici"; // Remplacez par une vraie cl√©

        // Initialisation
        window.onload = function() {
            loadUserData();
            initializeVoices();
            if (currentUser) {
                showMainInterface();
                loadConversations();
                loadFiles();
                applyUserSettings();
            } else {
                showLoginScreen();
            }
        };

        // Initialisation des voix
        function initializeVoices() {
            if ('speechSynthesis' in window) {
                voices = speechSynthesis.getVoices();
                populateVoiceSelects();
                
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = populateVoiceSelects;
                }
            }
        }

        function populateVoiceSelects() {
            voices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voice-select');
            const ttsVoiceSelect = document.getElementById('tts-voice');
            
            voiceSelect.innerHTML = '<option disabled>S√©lectionnez une voix</option>';
            ttsVoiceSelect.innerHTML = '<option value="">Voix par d√©faut</option>';
            
            voices.forEach((voice, index) => {
                const option1 = document.createElement('option');
                option1.value = index;
                option1.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = index;
                option2.textContent = `${voice.name} (${voice.lang})`;
                ttsVoiceSelect.appendChild(option2);
            });
        }

        // Gestion des vues
        function showLoginScreen() {
            hideAllScreens();
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function showMainInterface() {
            hideAllScreens();
            document.getElementById('sidebar').classList.remove('hidden');
            showChatView();
            updateUserInfo();
            checkAdminAccess();
        }

        function showChatView() {
            hideAllScreens();
            document.getElementById('chat-screen').classList.remove('hidden');
            updateActiveNav('chat');
        }

        function showHistoryView() {
            hideAllScreens();
            document.getElementById('history-screen').classList.remove('hidden');
            updateActiveNav('history');
            displayHistory();
        }

        function showFilesView() {
            hideAllScreens();
            document.getElementById('files-screen').classList.remove('hidden');
            updateActiveNav('files');
            displayFiles();
        }

        function showSettingsView() {
            hideAllScreens();
            document.getElementById('settings-screen').classList.remove('hidden');
            updateActiveNav('settings');
            loadSettings();
        }

        function showProfileView() {
            hideAllScreens();
            document.getElementById('profile-screen').classList.remove('hidden');
            updateActiveNav('profile');
            loadProfile();
        }

        function showAdminView() {
            hideAllScreens();
            document.getElementById('admin-screen').classList.remove('hidden');
            updateActiveNav('admin');
        }

        function hideAllScreens() {
            const screens = ['login-screen', 'chat-screen', 'history-screen', 'files-screen', 'settings-screen', 'profile-screen', 'admin-screen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        function updateActiveNav(activeId) {
            const links = document.querySelectorAll('#sidebar .menu a');
            links.forEach(link => {
                link.classList.remove('active');
                if (link.id === `nav-${activeId}`) {
                    link.classList.add('active');
                }
            });
        }

        // Authentification
        function switchToLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        }

        function switchToRegister() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        function registerUser() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            if (!name || !email || !password) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            // V√©rifier si l'email existe d√©j√†
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            if (existingUsers.find(u => u.email === email)) {
                alert('Cet email est d√©j√† utilis√©');
                return;
            }

            // Cr√©er l'utilisateur
            const user = {
                id: Date.now(),
                name: name,
                email: email,
                password: btoa(password), // Simple encodage (pas s√©curis√© en production)
                apiKey: DEFAULT_API_KEY,
                role: 'user',
                settings: {
                    theme: 'light',
                    model: 'mistral-medium-latest',
                    temperature: 70,
                    webSearch: true,
                    quickCopy: true,
                    autoSuggestions: true,
                    contextMemory: true,
                    adaptiveTheme: false
                },
                createdAt: new Date().toISOString()
            };

            existingUsers.push(user);
            localStorage.setItem('users', JSON.stringify(existingUsers));
            localStorage.setItem('currentUser', JSON.stringify(user));
            currentUser = user;
            showMainInterface();
        }

        function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            // V√©rifier si l'utilisateur existe
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.email === email && u.password === btoa(password));
            
            if (user) {
                localStorage.setItem('currentUser', JSON.stringify(user));
                currentUser = user;
                showMainInterface();
            } else {
                alert('Email ou mot de passe incorrect');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoginScreen();
        }

        // Mise √† jour des informations utilisateur
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('user-name').textContent = `Bonjour, ${currentUser.name.split(' ')[0]}`;
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('profile-avatar-lg').textContent = currentUser.name.charAt(0).toUpperCase();
            }
        }

        // Chargement des donn√©es
        function loadUserData() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                currentUser = JSON.parse(user);
            }

            const convs = localStorage.getItem('conversations');
            if (convs) {
                conversations = JSON.parse(convs);
            }

            const filesData = localStorage.getItem('files');
            if (filesData) {
                files = JSON.parse(filesData);
            }
        }

        // Sauvegarde des donn√©es
        function saveUserData() {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            localStorage.setItem('conversations', JSON.stringify(conversations));
            localStorage.setItem('files', JSON.stringify(files));
        }

        // Profil
        function loadProfile() {
            if (currentUser) {
                document.getElementById('profile-name').textContent = currentUser.name;
                document.getElementById('profile-email').textContent = currentUser.email;
                document.getElementById('profile-full-name').value = currentUser.name;
                document.getElementById('profile-email-input').value = currentUser.email;
                document.getElementById('profile-api-key').value = currentUser.apiKey || '';
            }
        }

        function saveProfile() {
            if (currentUser) {
                const newApiKey = document.getElementById('profile-api-key').value;
                const newFullName = document.getElementById('profile-full-name').value;
                const newEmail = document.getElementById('profile-email-input').value;
                const currentPass = document.getElementById('current-password').value;
                const newPass = document.getElementById('new-password').value;

                if (newApiKey) {
                    currentUser.apiKey = newApiKey;
                }
                
                if (newFullName) {
                    currentUser.name = newFullName;
                }
                
                if (newEmail) {
                    currentUser.email = newEmail;
                }
                
                if (currentPass && newPass) {
                    if (currentUser.password === btoa(currentPass)) {
                        currentUser.password = btoa(newPass);
                    } else {
                        alert('Mot de passe actuel incorrect');
                        return;
                    }
                }

                // Mettre √† jour dans la liste des utilisateurs
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                }

                saveUserData();
                updateUserInfo();
                alert('Profil sauvegard√© avec succ√®s !');
            }
        }

        // Param√®tres
        function loadSettings() {
            if (currentUser && currentUser.settings) {
                document.getElementById('theme-select').value = currentUser.settings.theme || 'light';
                document.getElementById('ai-model').value = currentUser.settings.model || 'mistral-medium-latest';
                const temp = currentUser.settings.temperature || 70;
                document.getElementById('ai-temperature').value = temp;
                document.getElementById('temp-value').textContent = temp;
                document.getElementById('web-search').checked = currentUser.settings.webSearch !== false;
                document.getElementById('quick-copy').checked = currentUser.settings.quickCopy !== false;
                document.getElementById('auto-suggestions').checked = currentUser.settings.autoSuggestions !== false;
                document.getElementById('context-memory').checked = currentUser.settings.contextMemory !== false;
                document.getElementById('adaptive-theme').checked = currentUser.settings.adaptiveTheme === true;
            }
        }

        function saveSettings() {
            if (currentUser) {
                if (!currentUser.settings) {
                    currentUser.settings = {};
                }
                currentUser.settings.theme = document.getElementById('theme-select').value;
                currentUser.settings.model = document.getElementById('ai-model').value;
                currentUser.settings.temperature = parseInt(document.getElementById('ai-temperature').value);
                currentUser.settings.webSearch = document.getElementById('web-search').checked;
                currentUser.settings.quickCopy = document.getElementById('quick-copy').checked;
                currentUser.settings.autoSuggestions = document.getElementById('auto-suggestions').checked;
                currentUser.settings.contextMemory = document.getElementById('context-memory').checked;
                currentUser.settings.adaptiveTheme = document.getElementById('adaptive-theme').checked;
                
                saveUserData();
                applyUserSettings();
                alert('Param√®tres sauvegard√©s avec succ√®s !');
            }
        }

        function applyUserSettings() {
            if (currentUser && currentUser.settings) {
                // Appliquer le th√®me
                document.documentElement.setAttribute('data-theme', currentUser.settings.theme || 'light');
                
                // Appliquer les autres param√®tres
                if (currentUser.settings.adaptiveTheme) {
                    applyAdaptiveTheme();
                }
            }
        }

        function changeTheme() {
            const theme = document.getElementById('theme-select').value;
            document.documentElement.setAttribute('data-theme', theme);
            if (currentUser) {
                currentUser.settings.theme = theme;
                saveUserData();
            }
        }

        function toggleAdaptiveTheme() {
            const isChecked = document.getElementById('adaptive-theme').checked;
            if (isChecked) {
                applyAdaptiveTheme();
            }
        }

        function applyAdaptiveTheme() {
            const hour = new Date().getHours();
            let theme = 'light';
            if (hour < 6 || hour >= 18) {
                theme = 'dark';
            }
            document.documentElement.setAttribute('data-theme', theme);
            if (currentUser) {
                currentUser.settings.theme = theme;
                saveUserData();
            }
        }

        // Chat
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ajouter le message utilisateur
            addMessage('user', message);
            
            // Effacer l'input
            input.value = '';
            
            // Cr√©er une nouvelle conversation si n√©cessaire
            if (!currentConversation || isEphemeralMode) {
                newConversation();
            }
            
            // Sauvegarder la conversation
            if (!isEphemeralMode) {
                saveCurrentConversation();
            }
            
            // D√©sactiver les boutons pendant le chargement
            const sendBtn = document.querySelector('button[onclick="sendMessage()"]');
            const voiceBtn = document.getElementById('voice-btn');
            sendBtn.disabled = true;
            voiceBtn.disabled = true;
            
            // Indicateur de saisie
            document.getElementById('typing-indicator').classList.remove('hidden');
            
            try {
                // R√©cup√©rer tous les messages
                const messages = getConversationMessages();
                
                // Appeler l'API
                const response = await callMistralAPI(messages);
                
                // Ajouter la r√©ponse de l'IA
                addMessage('assistant', response);
                
                // Sauvegarder la conversation
                if (!isEphemeralMode) {
                    saveCurrentConversation();
                }
                
            } catch (error) {
                // Afficher l'erreur
                addMessage('assistant', `‚ùå Erreur: ${error.message}`);
            } finally {
                // R√©activer les boutons
                sendBtn.disabled = false;
                voiceBtn.disabled = false;
                document.getElementById('typing-indicator').classList.add('hidden');
            }
        }

        function sendMessageFromSuggestion(text) {
            document.getElementById('message-input').value = text;
            sendMessage();
        }

        function addMessage(role, content) {
            const container = document.getElementById('messages-container');
            
            // Supprimer le message de bienvenue s'il existe
            if (container.children.length === 1 && container.children[0].classList.contains('text-center')) {
                container.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat ${role === 'user' ? 'chat-end' : 'chat-start'}`;
            
            const header = document.createElement('div');
            header.className = 'chat-header';
            header.textContent = role === 'user' ? 'üë§ Vous' : 'ü§ñ Wisdom AI';
            
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role === 'user' ? 'chat-bubble-primary' : 'chat-bubble-secondary'} message-content`;
            
            // Formater le contenu avec Markdown-like
            bubble.innerHTML = formatMessage(content);
            
            // Bouton de copie
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-xs btn-ghost copy-btn absolute top-2 right-2';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.onclick = () => copyToClipboard(content);
            copyBtn.title = 'Copier le texte';
            
            bubble.appendChild(copyBtn);
            messageDiv.appendChild(header);
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            
            // Scroll vers le bas
            container.scrollTop = container.scrollHeight;
            
            // Double-clic pour copier si activ√©
            if (currentUser?.settings?.quickCopy !== false) {
                bubble.ondblclick = () => copyToClipboard(content);
            }
        }

        function formatMessage(content) {
            // Convertir les titres markdown en HTML
            content = content.replace(/^### (.*$)/gim, '<h3 class="font-bold text-lg mt-4 mb-2">$1</h3>');
            content = content.replace(/^## (.*$)/gim, '<h2 class="font-bold text-xl mt-4 mb-2">$1</h2>');
            content = content.replace(/^# (.*$)/gim, '<h1 class="font-bold text-2xl mt-4 mb-2">$1</h1>');
            
            // Convertir les listes
            content = content.replace(/^\- (.*$)/gim, '<li class="ml-4">‚Ä¢ $1</li>');
            content = content.replace(/(<li.*<\/li>)/gs, '<ul class="list-none my-2">$1</ul>');
            
            // Convertir le gras
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convertir l'italique
            content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Convertir le code inline
            content = content.replace(/`(.*?)`/g, '<code>$1</code>');
            
            // Convertir les blocs de code
            content = content.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            // Convertir les sauts de ligne
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Animation de confirmation
                const originalText = event.target.innerHTML;
                event.target.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    event.target.innerHTML = originalText;
                }, 1000);
            });
        }

        function getConversationMessages() {
            const container = document.getElementById('messages-container');
            const messages = [];
            
            container.querySelectorAll('.chat').forEach(el => {
                const header = el.querySelector('.chat-header');
                const bubble = el.querySelector('.chat-bubble');
                
                if (header && bubble) {
                    const role = header.textContent.includes('Vous') ? 'user' : 'assistant';
                    const content = bubble.textContent.replace('Copier le texte', '').trim();
                    if (content) {
                        messages.push({ role, content });
                    }
                }
            });
            
            return messages;
        }

        // Appel √† l'API Mistral
        async function callMistralAPI(messages) {
            const apiKey = currentUser?.apiKey || DEFAULT_API_KEY;
            if (!apiKey) {
                throw new Error('Cl√© API manquante');
            }

            const model = currentUser?.settings?.model || 'mistral-medium-latest';
            const temperature = (currentUser?.settings?.temperature || 70) / 100;

            try {
                const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        temperature: temperature,
                        max_tokens: 2048
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Erreur API: ${response.status} - ${errorData.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                throw error;
            }
        }

        // Gestion des conversations
        function newConversation() {
            currentConversation = {
                id: Date.now(),
                title: 'Nouvelle conversation',
                messages: [],
                timestamp: new Date().toISOString(),
                isEphemeral: isEphemeralMode
            };
            
            const container = document.getElementById('messages-container');
            container.innerHTML = `
                <div class="text-center py-10">
                    <div class="text-5xl mb-4">üëã</div>
                    <h3 class="text-xl font-semibold">Nouvelle conversation</h3>
                    <p class="text-gray-500">Posez-moi une question pour commencer !</p>
                </div>
            `;
            
            if (!isEphemeralMode) {
                conversations.unshift(currentConversation);
                saveUserData();
            }
        }

        function toggleEphemeralMode() {
            isEphemeralMode = !isEphemeralMode;
            const btn = event.target;
            btn.innerHTML = isEphemeralMode ? 
                '<i class="fas fa-hourglass-half"></i> Mode √©ph√©m√®re (ON)' : 
                '<i class="fas fa-hourglass-half"></i> Mode √©ph√©m√®re';
            newConversation();
        }

        function saveCurrentConversation() {
            if (!currentConversation || isEphemeralMode) return;
            
            const messages = getConversationMessages();
            if (messages.length > 0) {
                currentConversation.title = messages[0].content.substring(0, 50) + (messages[0].content.length > 50 ? '...' : '');
                currentConversation.messages = messages;
                currentConversation.timestamp = new Date().toISOString();
                
                // Mettre √† jour dans la liste
                const existingIndex = conversations.findIndex(c => c.id === currentConversation.id);
                if (existingIndex >= 0) {
                    conversations[existingIndex] = currentConversation;
                } else {
                    conversations.unshift(currentConversation);
                }
                
                saveUserData();
            }
        }

        function loadConversations() {
            // Les conversations sont d√©j√† charg√©es dans la variable globale
        }

        function displayHistory() {
            const container = document.getElementById('history-list');
            if (conversations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-3"></i>
                        <p>Aucune conversation pour le moment</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = conversations.map(conv => `
                <div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow">
                    <div class="card-body p-4">
                        <h3 class="font-bold">${conv.title}</h3>
                        <p class="text-sm text-gray-500">${new Date(conv.timestamp).toLocaleString('fr-FR')}</p>
                        <div class="card-actions justify-end mt-2 space-x-2">
                            <button class="btn btn-xs btn-primary" onclick="loadConversation(${conv.id})">
                                <i class="fas fa-eye mr-1"></i>Voir
                            </button>
                            <button class="btn btn-xs btn-ghost" onclick="exportConversationById(${conv.id})">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-xs btn-error" onclick="deleteConversation(${conv.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadConversation(id) {
            const conv = conversations.find(c => c.id === id);
            if (conv) {
                currentConversation = conv;
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                
                conv.messages.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });
                
                showChatView();
            }
        }

        function deleteConversation(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette conversation ?')) {
                conversations = conversations.filter(c => c.id !== id);
                saveUserData();
                displayHistory();
                if (currentConversation && currentConversation.id === id) {
                    newConversation();
                }
            }
        }

        function clearHistory() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer tout l\'historique ? Cette action est irr√©versible.')) {
                conversations = [];
                saveUserData();
                displayHistory();
                newConversation();
            }
        }

        function exportConversation() {
            if (!currentConversation) {
                alert('Aucune conversation √† exporter');
                return;
            }
            
            const content = currentConversation.messages.map(msg => 
                `${msg.role === 'user' ? 'Vous' : 'Wisdom'}: ${msg.content}`
            ).join('\n\n');
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportConversationById(id) {
            const conv = conversations.find(c => c.id === id);
            if (conv) {
                const content = conv.messages.map(msg => 
                    `${msg.role === 'user' ? 'Vous' : 'Wisdom'}: ${msg.content}`
                ).join('\n\n');
                
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `conversation-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Gestion des fichiers
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                saveFile(file);
                event.target.value = ''; // Reset input
            }
        }

        function handleGlobalFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                saveFile(file);
                event.target.value = ''; // Reset input
            }
        }

        function saveFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const fileData = {
                    id: Date.now(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    content: e.target.result,
                    timestamp: new Date().toISOString()
                };
                
                files.push(fileData);
                saveUserData();
                displayFiles();
                alert(`Fichier "${file.name}" t√©l√©charg√© avec succ√®s !`);
            };
            
            if (file.type.startsWith('image/')) {
                reader.readAsDataURL(file);
            } else {
                reader.readAsText(file);
            }
        }

        function displayFiles() {
            const container = document.getElementById('files-list');
            if (files.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-file-alt text-3xl mb-3"></i>
                        <p>Aucun fichier t√©l√©charg√©</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body p-4">
                        <div class="flex items-center space-x-3">
                            <i class="fas ${getFileIcon(file.type)} text-2xl"></i>
                            <div class="flex-1">
                                <h3 class="font-bold">${file.name}</h3>
                                <p class="text-sm text-gray-500">${formatFileSize(file.size)} ‚Ä¢ ${new Date(file.timestamp).toLocaleString('fr-FR')}</p>
                            </div>
                        </div>
                        <div class="card-actions justify-end mt-2 space-x-2">
                            <button class="btn btn-xs btn-primary" onclick="downloadFile(${file.id})">
                                <i class="fas fa-download mr-1"></i>T√©l√©charger
                            </button>
                            <button class="btn btn-xs btn-ghost" onclick="previewFile(${file.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-xs btn-error" onclick="deleteFile(${file.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'fa-file-image text-blue-500';
            if (type.includes('pdf')) return 'fa-file-pdf text-red-500';
            if (type.includes('word')) return 'fa-file-word text-blue-600';
            if (type.includes('excel')) return 'fa-file-excel text-green-600';
            if (type.includes('audio')) return 'fa-file-audio text-purple-500';
            if (type.includes('video')) return 'fa-file-video text-pink-500';
            return 'fa-file text-gray-500';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(id) {
            const file = files.find(f => f.id === id);
            if (file) {
                const blob = new Blob([file.content], { type: file.type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        function previewFile(id) {
            const file = files.find(f => f.id === id);
            if (file) {
                if (file.type.startsWith('image/')) {
                    // Afficher l'image dans une modale
                    const modal = document.createElement('div');
                    modal.className = 'modal modal-open';
                    modal.innerHTML = `
                        <div class="modal-box max-w-4xl">
                            <h3 class="font-bold text-lg">${file.name}</h3>
                            <img src="${file.content}" alt="${file.name}" class="w-full max-h-96 object-contain">
                            <div class="modal-action">
                                <button class="btn" onclick="this.closest('.modal').remove()">Fermer</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else if (file.type.startsWith('text/')) {
                    // Afficher le texte dans une modale
                    const modal = document.createElement('div');
                    modal.className = 'modal modal-open';
                    modal.innerHTML = `
                        <div class="modal-box max-w-4xl">
                            <h3 class="font-bold text-lg">${file.name}</h3>
                            <div class="bg-base-200 p-4 rounded max-h-96 overflow-auto">
                                <pre class="whitespace-pre-wrap">${file.content.substring(0, 1000)}${file.content.length > 1000 ? '...' : ''}</pre>
                            </div>
                            <div class="modal-action">
                                <button class="btn" onclick="this.closest('.modal').remove()">Fermer</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    alert('Aper√ßu non disponible pour ce type de fichier');
                }
            }
        }

        function deleteFile(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce fichier ?')) {
                files = files.filter(f => f.id !== id);
                saveUserData();
                displayFiles();
            }
        }

        // Reconnaissance vocale
        function toggleVoice() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('üé§ Reconnaissance vocale non support√©e dans ce navigateur');
                return;
            }

            if (!recognition) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.interimResults = false;
                recognition.continuous = false;

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('message-input').value = transcript;
                    isListening = false;
                    updateVoiceButton();
                };

                recognition.onerror = (event) => {
                    console.error('Erreur de reconnaissance vocale:', event.error);
                    isListening = false;
                    updateVoiceButton();
                };

                recognition.onend = () => {
                    isListening = false;
                    updateVoiceButton();
                };
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
            } else {
                recognition.start();
                isListening = true;
            }

            updateVoiceButton();
        }

        function updateVoiceButton() {
            const btn = document.getElementById('voice-btn');
            if (isListening) {
                btn.innerHTML = '<i class="fas fa-stop"></i>';
                btn.className = 'btn btn-error';
            } else {
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                btn.className = 'btn btn-secondary';
            }
        }

        function changeVoice() {
            // Cette fonction est pour s√©lectionner la voix de reconnaissance
            // La voix de synth√®se est g√©r√©e s√©par√©ment
        }

        // Synth√®se vocale
        function testVoice() {
            const text = "Bonjour, je suis Wisdom AI. Je peux vous aider √† r√©pondre √† toutes vos questions.";
            speakText(text);
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                const voiceIndex = document.getElementById('tts-voice').value;
                const volume = document.getElementById('tts-volume').value / 100;
                
                if (voiceIndex && voices[voiceIndex]) {
                    utterance.voice = voices[voiceIndex];
                }
                
                utterance.volume = volume;
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                speechSynthesis.speak(utterance);
            }
        }

        // Administration
        function checkAdminAccess() {
            if (currentUser && currentUser.role === 'admin') {
                document.getElementById('admin-panel-link').classList.remove('hidden');
            }
        }

        function authenticateAdmin() {
            const code = document.getElementById('admin-code').value;
            if (code === ADMIN_CODE) {
                document.getElementById('admin-content').classList.remove('hidden');
                loadAdminData();
            } else {
                alert('Code d\'administration incorrect');
            }
        }

        function loadAdminData() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const table = document.getElementById('users-table');
            
            table.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>
                        <button class="btn btn-xs btn-error" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteUser(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?')) {
                let users = JSON.parse(localStorage.getItem('users') || '[]');
                users = users.filter(u => u.id !== id);
                localStorage.setItem('users', JSON.stringify(users));
                
                // Si c'est l'utilisateur actuel, le d√©connecter
                if (currentUser && currentUser.id === id) {
                    logout();
                } else {
                    loadAdminData();
                }
            }
        }

        function saveAdminSettings() {
            const defaultApiKey = document.getElementById('default-api-key').value;
            const dailyLimit = document.getElementById('daily-limit').value;
            
            // Sauvegarder dans localStorage
            if (defaultApiKey) {
                localStorage.setItem('defaultApiKey', defaultApiKey);
            }
            localStorage.setItem('dailyLimit', dailyLimit);
            
            alert('Param√®tres administratifs sauvegard√©s !');
        }

        // M√©moire contextuelle
        function saveContextMemory() {
            // Sauvegarder le contexte de la conversation actuelle
            if (currentConversation && !isEphemeralMode) {
                localStorage.setItem('currentContext', JSON.stringify(currentConversation));
            }
        }

        function loadContextMemory() {
            // Charger le contexte sauvegard√©
            const context = localStorage.getItem('currentContext');
            if (context) {
                currentConversation = JSON.parse(context);
                return true;
            }
            return false;
        }

        // Recherche web (simulation)
        async function webSearch(query) {
            // Simulation de recherche web
            return `R√©sultats de recherche pour "${query}":\n\n1. Article pertinent sur le sujet\n2. Documentation officielle\n3. Forum de discussion\n\n*Note: Cette fonctionnalit√© n√©cessite une int√©gration avec une API de recherche r√©elle.*`;
        }

        // Gestion des raccourcis clavier
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter pour envoyer
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                sendMessage();
            }
            
            // Esc pour arr√™ter la reconnaissance vocale
            if (e.key === 'Escape' && isListening) {
                toggleVoice();
            }
        });

        // Gestion du redimensionnement
        window.addEventListener('resize', function() {
            const container = document.getElementById('messages-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        });
    </script>
</body>
</html>

